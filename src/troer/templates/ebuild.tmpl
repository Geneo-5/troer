## Setup Cheetah compiler placeholder delimiter to '@' instead of the default
## '$' to prevent from conflicting with makefile syntax.
#compiler-settings
cheetahVarStartToken = @
commentStartToken = @@@@
directiveStartToken = @@
directiveEndToken = @@
EOLSlurpToken = @@
multilineCommentStartToken = @@*
multilineCommentEndToken = *@@
#end compiler-settings
@@@@ Lines up to (and including) this one will get discarded from final output.
################################################################################
# SPDX-License-Identifier: LGPL-3.0-only
#
# This file is part of @{lib.name}.
# This file is generated by troer, don't edit manually.
################################################################################

@@if @builtin
builtins             = builtin.a
builtin.a-cflags     = $(EXTRA_CFLAGS)
builtin.a-objs       = @{lib.name}.o
@@if @lib.json
builtin.a-objs      += @{lib.name}-json.o
@@end if
@@if @lib.schema == 'exchange'
builtin.a-objs      += @{lib.name}-srv.o
builtin.a-objs      += @{lib.name}-clt.o
@@end if
@@else

config-in   := Config.in
config-h    := $(PACKAGE)/config.h
config-obj  := config.o

# Enable a bunch of warning options and disable -ffinite-math-only optimizations
# so that floating point number classification macros such as isnan() works
# properly (since NaN and Infinity values are tested).
common-cflags         := -Wall \
                         -Wextra \
                         -Wformat=2 \
                         -Wconversion \
                         -Wundef \
                         -Wshadow \
                         -Wcast-qual \
                         -Wcast-align \
                         -Wmissing-declarations \
                         -D_GNU_SOURCE \
                         -I $(TOPDIR)/include \
                         $(filter-out -ffinite-math-only,$(EXTRA_CFLAGS)) \
                         -fno-finite-math-only \
                         -fvisibility=hidden \
                         -Werror
common-ldflags        := $(common-cflags) \
                         $(EXTRA_LDFLAGS) \
                         -Wl,-z,start-stop-visibility=hidden

@@if @shared
solibs := lib@{lib.name}.so
lib@{lib.name}.so-objs       = shared/@{lib.name}.o
@@if @lib.json
lib@{lib.name}.so-objs      += shared/@{lib.name}-json.o
@@end if
@@if @lib.schema == 'exchange'
lib@{lib.name}.so-objs      += shared/@{lib.name}-srv.o
lib@{lib.name}.so-objs      += shared/@{lib.name}-clt.o
@@end if
lib@{lib.name}.so-cflags     = $(filter-out -fpie -fPIE,$(common-cflags)) -fpic
lib@{lib.name}.so-ldflags    = $(filter-out -fpie -fPIE,$(common-ldflags))
lib@{lib.name}.so-ldflags   += -shared -Bsymbolic -fpic
lib@{lib.name}.so-ldflags   += -Wl,-soname,lib@{lib.name}.so
lib@{lib.name}.so-pkgconfig  =@{pkgconfig}

@@end if
@@if @static
arlibs := lib@{lib.name}.a
lib@{lib.name}.a-objs      = static/@{lib.name}.o
@@if @lib.json
lib@{lib.name}.a-objs     += static/@{lib.name}-json.o
@@end if
@@if @lib.schema == 'exchange'
lib@{lib.name}.a-objs     += static/@{lib.name}-srv.o
lib@{lib.name}.a-objs     += static/@{lib.name}-clt.o
@@end if
lib@{lib.name}.a-cflags    = $(common-cflags)
lib@{lib.name}.a-pkgconfig =@{pkgconfig}

@@end if
HEADERDIR := $(CURDIR)/include
headers    = @{lib.name}/lib.h

define @{lib.id}_pkgconf_tmpl
prefix=$(PREFIX)
exec_prefix=$${prefix}
libdir=$${exec_prefix}/lib
includedir=$${prefix}/include

Name: lib@{lib.name}
Description: @{lib.doc}
Version: $(VERSION)
Requires.private: @{pkgconfig}
Requires:
Cflags: -I$${includedir}
#if @shared
Libs: -L$${libdir} -Wl,--push-state,--as-needed -l@{lib.name} -Wl,--pop-state
#end if
endef

pkgconfigs := lib@{lib.name}.pc
lib@{lib.name}.pc-tmpl := @{lib.id}_pkgconf_tmp

################################################################################
# Source code tags generation
################################################################################

tagfiles := $(shell find $(CURDIR) $(HEADERDIR) -type f)

################################################################################
# Documentation generation
################################################################################

doxyconf  := $(CURDIR)/sphinx/Doxyfile
doxyenv   := SRCDIR="$(HEADERDIR) $(CURDIR)"

sphinxsrc := $(CURDIR)/sphinx
sphinxenv := \
	VERSION="$(VERSION)" \
	PROJECT="@{lib.name}" \
	$(if $(strip $(EBUILDDOC_TARGET_PATH)), \
	     EBUILDDOC_TARGET_PATH="$(strip $(EBUILDDOC_TARGET_PATH))") \
	$(if $(strip $(EBUILDDOC_INVENTORY_PATH)), \
	     EBUILDDOC_INVENTORY_PATH="$(strip $(EBUILDDOC_INVENTORY_PATH))") \
	$(if $(strip $(DPACKDOC_TARGET_PATH)), \
	     DPACKDOC_TARGET_PATH="$(strip $(DPACKDOC_TARGET_PATH))") \
	$(if $(strip $(DPACKDOC_INVENTORY_PATH)), \
	     DPACKDOC_INVENTORY_PATH="$(strip $(DPACKDOC_INVENTORY_PATH))") \
	$(if $(strip $(STROLLDOC_TARGET_PATH)), \
	     STROLLDOC_TARGET_PATH="$(strip $(STROLLDOC_TARGET_PATH))") \
	$(if $(strip $(STROLLDOC_INVENTORY_PATH)), \
	     STROLLDOC_INVENTORY_PATH="$(strip $(STROLLDOC_INVENTORY_PATH))")

################################################################################
# Source distribution generation
################################################################################

override distfiles = include/@{lib.name}/lib.h \
                     sphinx/license/gpl.rst \
                     sphinx/license/lgpl.rst \
                     sphinx/api.rst \
                     sphinx/conf.py \
                     sphinx/Doxyfile \
                     sphinx/genindex.rst \
                     sphinx/index.rst \
                     sphinx/install.rst \
                     sphinx/license.rst \
                     Config.in \
                     COPYING \
                     COPYING.LESSER \
                     ebuild.mk \
                     Makefile \
                     README.rst \
@@if @lib.schema == 'exchange'
                     @{lib.name}-srv.c \
                     @{lib.name}-clt.c \
@@end if
@@if @lib.json
                     @{lib.name}-json.c \
@@end if
                     @{lib.name}.c

# Override InterSphinx eBuild base documentation URI and make it point to online
# GitHub pages when building final source distribution tarball
dist: export EBUILDDOC_TARGET_PATH := http://grgbr.github.io/ebuild/
dist: export STROLLDOC_TARGET_PATH := http://grgbr.github.io/stroll/
dist: export DPACKDOC_TARGET_PATH  := http://grgbr.github.io/dpack/
@@if @lib.schema == 'exchange'
dist: export GALVDOC_TARGET_PATH   := http://grgbr.github.io/galv/
dist: export HEDDOC_TARGET_PATH    := http://geneo-5.github.io/hed/
@@end if

@@end if
# ex: filetype=make
