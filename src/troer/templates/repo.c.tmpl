static void __${pre}nonull(1)
${pre}close(${type} * repo)
{
	${assert_fn}(repo);

	if (!repo->env)
		return;

	if (repo->txn)
		${pid}_abort(repo);

	mdb_env_close(repo->env);
	repo->env = NULL;
}

static int __${pre}nonull(1) __warn_result
${pre}open(${type} * repo, int flags)
{
	${assert_fn}(repo);
	${assert_fn}(!repo->env);
	${assert_fn}(!repo->txn);

	int ret;
	unsigned int f = flags & O_RDONLY ? MDB_RDONLY : 0;
	MDB_dbi dbi;

	ret = mdb_env_create(&repo->env);
	if (ret)
		return ret;

#set $nb = len($entries)
	ret = mdb_env_set_maxdbs(repo->env, ${nb});
	if (ret)
		goto error;

	ret = mdb_env_open(repo->env, stroll_lvstr_cstr(&repo->path), f, repo->mode);
	if (ret)
		goto error;

	ret = ${pid}_start(repo);
	if (ret)
		goto error;
#for $e in $entries

	f = flags & O_CREAT ? MDB_CREATE : 0;
	ret = mdb_dbi_open(repo->txn, "${e.id}", f, &dbi);
	if (ret)
		goto error;

	if (flags & O_TRUNC) {
		ret = mdb_drop(repo->txn, dbi, 0);
		if (ret)
			goto error;
	}
#end for
	
	return ${pid}_commit(repo);

error:
	${pre}close(repo);
	return ret;
}

int __${pre}nonull(1, 2) __warn_result
${pre}open_${id}(${type} * repo, const char * path, int flags, mode_t mode)
{
	${assert_fn}(repo);
	${assert_fn}(path);
	${assert_fn}(strlen(path) > 0);
	${assert_fn}(!(flags & (~(O_RDWR | O_RDONLY | O_CREAT | O_TRUNC))));
	${assert_fn}(!(flags & O_CREAT) | (flags & O_RDWR));
	${assert_fn}(!(flags & O_TRUNC) | (flags & O_CREAT));

	int ret;

	repo->env = NULL;
	repo->txn = NULL;
	repo->flags = flags & O_ACCMODE;
	repo->mode = mode;
	repo->buf = malloc(sizeof(char) * ${pid.upper()}_MAX_PAYLOAD);
	if (!repo->buf)
		return -ENOMEM;

	ret = stroll_lvstr_init_dup(&repo->path, path);
	if (ret) {
		free(repo->buf);
		return ret;
	}
	
	ret = ${pre}open(repo, flags);
	if (ret) {
		stroll_lvstr_fini(&repo->path);
		free(repo->buf);
	}

	return ret;
}

void __${pre}nonull(1)
${pre}close_${id}(${type} * repo)
{
	${pre}close(repo);
	stroll_lvstr_fini(&repo->path);
	free(repo->buf);
}


int __${pre}nonull(1)
${pid}_start(${type} * repo)
{
	${assert_fn}(repo);
	${assert_fn}(repo->env);
	${assert_fn}(!repo->txn);

	unsigned int flags = repo->flags & O_RDONLY ? MDB_RDONLY : 0;

	return mdb_txn_begin(repo->env, NULL, flags, &repo->txn);
}

int __${pre}nonull(1)
${pid}_commit(${type} * repo)
{
	${assert_fn}(repo);
	${assert_fn}(repo->env);
	${assert_fn}(repo->txn);

	int ret;

	ret = mdb_txn_commit(repo->txn);
	repo->txn = NULL;
	return ret;
}

void __${pre}nonull(1)
${pid}_abort(${type} * repo)
{
	${assert_fn}(repo);
	${assert_fn}(repo->env);
	${assert_fn}(repo->txn);
	
	mdb_txn_abort(repo->txn);
	repo->txn = NULL;
}

int __${pre}nonull(1)
${pre}reload_${id}(${type} * repo)
{
	${assert_fn}(repo);

	${pre}close(repo);
	return ${pre}open(repo, repo->flags);
}

#for $e in $entries
${e.getDefinition()}
#end for
## ex: filetype=c
