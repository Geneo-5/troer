/**
 * Minimum size in bytes of an ${type} serialized according to
 * the @rstsubst{MessagePack int format}.
 */
\#define ${pid.upper()}_PACKED_SIZE_MIN $defineMIN()
	
/**
 * Maximum size in bytes of an ${type} serialized according to
 * the @rstsubst{MessagePack int format}.
 */
\#define ${pid.upper()}_PACKED_SIZE_MAX $defineMAX()

${type} {
#for $e in $entries
#if 'repeated' in $e
#if isinstance(e.repeated, int)
	${e.type} ${e.id}[${e.repeated}];
#else
	size_t     ${e.id}_nb;
	${e.type} *${e.id};
#end if
#else
	${e.type} ${e.id};
#end if
#end for
};
#if $app_check

/**
 * Applicative check if input is valid ${type}
 *
 * @param[in] value The value to test
 *
 * @return an errno like error code
 * @retval 0       Success
 * @retval -EINVAL Invalid value
 */
extern int
${app_check}(const ${type} * value)
__${pre}nonull(1) __warn_result;
#end if

/**
 * Check if input is valid ${type}
 *
 * @param[in] value The value to test
 *
 * @return an errno like error code
 * @retval 0       Success
 * @retval -EINVAL Invalid value
 */
extern int
${check}(const ${type} * value)
__${pre}nonull(1) __warn_result ${deprecated};

/**
 * Decode a ${type} encoded according to the MessagePack format
 *
 * @param[inout] decoder decoder
 * @param[out]   value   location where to store decoded value
 *
 * @return an errno like error code
 * @retval 0         Success
 * @retval -EPROTO   Not a valid MessagePack stream
 * @retval -ENOTSUP  Unsupported MessagePack stream data
 * @retval -ENOMSG   Invalid MessagePack stream data type or range
 * @retval -EMSGSIZE Not enough space to complete operation
 * @retval -ENOMEM   Memory allocation failure
 *
 * @warning
 * - @p decoder *MUST* have been initialized using dpack_decoder_init_buffer()
 *   or dpack_decoder_init_skip_buffer() before calling this function. Result is
 *   undefined otherwise.
 * - When compiled with the #CONFIG_${lib.id.upper()}_ASSERT build option
 *   disabled and @p decoder is in error state before calling this function,
 *   result is undefined. An assertion is triggered otherwise.
 * - @p value *MUST* have been initialized using ${init}()
 *   before calling this function. Result is undefined otherwise.
 *
 * @see
 * - dpack_decoder_init_buffer()
 * - dpack_decoder_init_skip_buffer()
 * - ${init}()
 */
extern int
${decode}(struct dpack_decoder * decoder,
	  ${type} * __restrict value)
__${pre}nonull(1, 2) __nothrow __warn_result ${deprecated};

/**
 * Encode an ${type} according to the MessagePack format
 * @param[inout] encoder encoder
 * @param[in]    value  ${pid} value to encode
 *
 * @return an errno like error code
 * @retval 0         Success
 * @retval -EMSGSIZE Not enough space to complete operation
 * @retval -ENOMEM   Memory allocation failure
 *
 * @warning
 * - @p encoder *MUST* have been initialized using dpack_encoder_init_buffer()
 *   before calling this function. Result is undefined otherwise.
 * - When compiled with the #CONFIG_${lib.id.upper()}_ASSERT build option
 *   disabled and @p decoder is in error state before calling this function,
 *   result is undefined. An assertion is triggered otherwise.
 * - @p value *MUST* have been initialized using ${init}()
 *   before calling this function. Result is undefined otherwise.
 *
 * @see
 * - dpack_encode_int8()
 * - dpack_encoder_init_buffer()
 * - ${init}()
 */
extern int
${encode}(struct dpack_encoder * encoder,
	  const ${type} * value)
__${pre}nonull(1, 2) __nothrow __warn_result ${deprecated};

#if $json
/**
 * Decode a ${type} encoded according to the MessagePack format
 *
 * @param[inout] decoder decoder
 *
 * @return an json-c object or NULL if error
 * @retval NULL      Error setted in errno.
 * @retval -EPROTO   Not a valid MessagePack stream
 * @retval -ENOTSUP  Unsupported MessagePack stream data
 * @retval -ENOMSG   Invalid MessagePack stream data type or range
 * @retval -EMSGSIZE Not enough space to complete operation
 * @retval -ENOMEM   Memory allocation failure
 *
 * @warning
 * - @p decoder *MUST* have been initialized using dpack_decoder_init_buffer()
 *   or dpack_decoder_init_skip_buffer() before calling this function. Result is
 *   undefined otherwise.
 * - When compiled with the #CONFIG_${lib.id.upper()}_ASSERT build option
 *   disabled and @p decoder is in error state before calling this function,
 *   result is undefined. An assertion is triggered otherwise.
 *
 * @see
 * - dpack_decoder_init_buffer()
 * - dpack_decoder_init_skip_buffer()
 */
struct json_object *
${decode}_to_json(struct dpack_decoder * decoder)
__${pre}nonull(1) __nothrow __warn_result ${deprecated};

/**
 * Encode an json ${type} according to the MessagePack format
 * @param[inout] encoder encoder
 * @param[in]    object json-object value to encode
 *
 * @return an errno like error code
 * @retval 0         Success
 * @retval -EMSGSIZE Not enough space to complete operation
 * @retval -ENOMEM   Memory allocation failure
 * @retval -EINVAL   Invalid value
 *
 * @warning
 * - @p encoder *MUST* have been initialized using dpack_encoder_init_buffer()
 *   before calling this function. Result is undefined otherwise.
 * - When compiled with the #CONFIG_${lib.id.upper()}_ASSERT build option
 *   disabled and @p decoder is in error state before calling this function,
 *   result is undefined. An assertion is triggered otherwise.
 *
 * @see
 * - dpack_encode_${dpack}()
 * - dpack_encoder_init_buffer()
 */
extern int
${encode}_from_json(struct dpack_encoder * encoder,
		    struct json_object * object)
__${pre}nonull(1, 2) __nothrow __warn_result ${deprecated};
#end if

/*
 * Initialize an empty ${type}_.
 * @param[out] value Length-Value String
 *
 * @return an arrno like error code
 * @retval 0         Success
 */
extern int
${init}(${type} * value)
 __${pre}nonull(1) __warn_result ${deprecated};

/*
 * Finalize an empty ${type}_.
 * @param[inout] value Length-Value String
 */
extern void
${fini}(${type} * value)
 __${pre}nonull(1) ${deprecated};
#for $e in $entries
#if 'repeated' in $e

static inline size_t  __${pre}nonull(1) ${deprecated}
${pid}_get_${e.id}_nb(const ${type} * value)
{
	${assert_fn}(value);

#if isinstance(e.repeated, int)
	return ${e.repeated};
#else
	return value->${e.id}_nb;
#end if
}

static inline ${e.type}${e.asterisk} __${pre}nonull(1) ${deprecated}
${pid}_get_${e.id}(const ${type} * value, unsigned int idx)
{
	${assert_fn}(value);
#if isinstance(e.repeated, int)
	${assert_fn}(idx < ${e.repeated});
#else
	${assert_fn}(idx < value->${e.id}_nb);
#end if

STROLL_IGNORE_WARN("-Wcast-qual")
	return (${e.type}${e.asterisk})${e.ampersand}value->${e.id}[idx];
STROLL_RESTORE_WARN
}
#if isinstance(e.repeated, int)
#if not e.asterisk

static inline void __${pre}nonull(1) ${deprecated}
${pid}_set_${e.id}(${type} * data, unsigned int idx, ${e.type} value)
{
	${assert_fn}(data);
	${assert_fn}(idx < ${e.repeated});

	data->${e.id}[idx] = value;
}
#end if
#else

extern  ${e.type} *
${pid}_append_${e.id}(${type} * data)
	__${pre}nonull(1) ${deprecated};
#end if
#else

static inline ${e.type}${e.asterisk} __${pre}nonull(1) ${deprecated}
${pid}_get_${e.id}(const ${type} * value)
{
	${assert_fn}(value);

STROLL_IGNORE_WARN("-Wcast-qual")
	return (${e.type}${e.asterisk})${e.ampersand}value->${e.id};
STROLL_RESTORE_WARN
}
#if not e.asterisk

static inline void __${pre}nonull(1) ${deprecated}
${pid}_set_${e.id}(${type} * data, ${e.type} value)
{
	${assert_fn}(data);

	data->${e.id} = value;
}
#end if
#end if
#end for

## ex: filetype=c
